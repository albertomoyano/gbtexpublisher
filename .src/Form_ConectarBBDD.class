' Gambas class file

Public meConn As New Connection
Public sArchivo As String

Public Sub Form_Open()

  Dim versionRemota As String
  Dim versionLocal As String = Application.Version

  versionRemota = Mod_Funciones.GitVersion("https://raw.githubusercontent.com/albertomoyano/gbtexpublisher/main/.project")

  If versionRemota <> "" Then
    Select Case CompararVersiones(versionLocal, versionRemota)
      Case -1
        Message.Info("Hay una nueva versión disponible: " & versionRemota)
      Case 0
        Print "Estás usando la última versión."
      Case 1
        Print "Tu versión local (" & versionLocal & ") es más reciente que la del repositorio."
    End Select
  Else
    Message.Warning("No se pudo obtener la versión remota.")
  Endif

  ' Dim versionRemota As String
  ' Dim versionLocal As String = Application.Version' Versión actual de la app
  '
  ' versionRemota = Mod_Funciones.GitVersion("https://raw.githubusercontent.com/albertomoyano/gbtexpublisher/refs/heads/main/.project")
  '
  ' If versionRemota <> "" And versionRemota <> versionLocal Then
  '   Message.Info("¡Tu versión instalada difiere de la versión disponible en el repositorio: " & versionRemota)
  ' Else
  '   Print "Estás usando la última versión."
  ' Endif

  Dim name As String
  ' Usamos pgrep para buscar procesos por el nombre exacto de la aplicación
  Exec ["pgrep", "-fl", Application.Name] Wait To name
  ' Mostramos el resultado para depurar (puedes eliminar esta línea después)
  ' Comprobamos que el resultado contenga más de un proceso
  If Split(Trim$(name), gb.NewLine, "", True).Count > 1 Then
    Message.Warning(Application.Name & " ya se está ejecutando.")
    Quit
  Endif

  Form_ConectarBBDD.Title = Application.Title & " v. " & Application.Version & " - programación orientada al usuario"

End

Public Function CompararVersiones(local As String, remota As String) As Integer

  Dim vl As String[] = Split(local, ".")
  Dim vr As String[] = Split(remota, ".")
  Dim i As Integer
  Dim l As Integer = Max(vl.Max, vr.Max)

  For i = 0 To l
    If Val(vl[i]) < Val(vr[i]) Then Return -1
    If Val(vl[i]) > Val(vr[i]) Then Return 1
  Next

  Return 0 ' Son iguales

End

Public Sub btnSelecionarBBDD_Click()

  ' Abrir un cuadro de diálogo para seleccionar un archivo
  Dialog.Title = "Seleccionar base de datos SQLite"
  Dialog.Filter = ["gbtexpublisher.sqlite", ""]' gbtexpublisher.sqlite
  Dialog.Path = txtRutaBBDD.Text
  If Dialog.OpenFile() Then Return

  ' Mostrar la ruta seleccionada en el TextBox
  sArchivo = Dialog.Path
  txtRutaBBDD.Text = sArchivo

  Dim respaldoBBDD As String = User.Home &/ ".respaldogbTeX"
  If Not Exist(respaldoBBDD) Then
    Mkdir respaldoBBDD
  Else
    Dim fecha As String
    fecha = Format(Date(), "dd-mm-yyyy") ' Obtener la fecha actual
    Shell "cp " & sArchivo & " " & respaldoBBDD &/ fecha & "-" & "gbtexpublisher.sqlite"
  End If

End

Public Sub btnCerrar_Click()' boton de cerrar la conexion

  Quit

End

Public Sub btnConectar_Click()' boton de conectar a la red

  ' condicional que revisa que exista la ruta y verifica si el TextBox está vacío o es Null
  If IsNull(txtRutaBBDD.Text) Or txtRutaBBDD.Text = "" Then
    Message.Error("Debe indicar una ruta válida donde encontrar la base de datos <strong>gbtexpublisher.sqlite</strong>.")
    Return ' Detiene la ejecución
  End If

  ' Usa la ruta seleccionada en el formulario de inicio
  meConn.Type = "sqlite3"
  meConn.Host = File.Dir(txtRutaBBDD.Text)
  meConn.Name = File.Dir(txtRutaBBDD.Text) & "/gbtexpublisher.sqlite"
  meConn.Open()
  ' Configurar el modo de journal a DELETE
  meConn.Exec("PRAGMA journal_mode=DELETE;")

  Form_ConectarBBDD.Center
  Form_ConectarBBDD.Visible = False
  ' Me.Hide
  FMain.Show

End
