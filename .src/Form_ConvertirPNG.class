' Gambas class file

Public Sub Convertir_Click()

  ' Validar que se haya ingresado un nombre para la salida
  If txtNombre.Text = "" Then
    Message.Error("Por favor, introduce un nombre para la salida.")
    Return
  Endif

  ' Validar que se haya seleccionado un archivo de origen
  If txtArchivoOrigen.Text = "" Then
    Message.Error("Por favor, selecciona un archivo de origen.")
    Return
  Endif

  ' Crear la ruta completa del archivo de salida
  Dim sOutputFile As String = File.Dir(FMain.TextBox1.Text) & "/media/" & txtNombre.Text & ".png"

  ' Construir el comando de conversión
  Dim sCommand As String
  sCommand = "convert " & txtArchivoOrigen.Text & " -colorspace Gray -density 300 -strip " & Quote$(sOutputFile)

  FMain.TerminalView1.Input(sCommand & "\n" & "clear" & "\n")

End

Public Sub btnOrigen_Click()

  Dialog.Title = "Seleccionar el archivo a convertir"
  Dialog.Filter = ["*.jpg;*.jpeg", "Archivos JPG y JPEG", "*.png", "Archivos PNG"]
  Dialog.Path = File.Dir(FMain.TextBox1.Text) & "/media/"
  If Dialog.OpenFile() Then
    Return
  Else
    txtArchivoOrigen.Text = Dialog.Path
  Endif

Catch
  Message.Error("La selección del archivo fue cancelada.")

End Sub

Public Sub btnCancelar_Click()

  Me.Close

End

Public Sub Form_Close()

  Me.Close

End

Public Sub txtNombre_KeyRelease()

  ' Obtener el texto actual del TextBox
  Dim texto As String

  texto = txtNombre.Text

  ' Lista de caracteres permitidos
  Dim caracteresPermitidos As String = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ@-"

  ' Filtrar el texto para eliminar caracteres no permitidos
  Dim textoFiltrado As String
  For i As Integer = 1 To Len(texto)
    Dim tecla As String
    tecla = Mid(texto, i, 1)
    If InStr(caracteresPermitidos, tecla) > 0 Then
      textoFiltrado = textoFiltrado & tecla
    End If
  Next

  ' Actualizar el TextBox con el texto filtrado y convertirlo a mayúsculas
  txtNombre.Text = UCase(textoFiltrado)

End
